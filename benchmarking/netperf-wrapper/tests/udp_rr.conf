## -*- mode: python; coding: utf-8 -*-

AGGREGATOR="timeseries"
TOTAL_LENGTH=LENGTH + 2
NETPERF_CMD="../netperf-2.6.0/src/netperf -fg -4"


AGGREGATOR='summary'
#AGGREGATOR='timeseries'
#DESCRIPTION='UDP Transactions'
DESCRIPTION='FancyEcho scalability'
DEFAULTS={'PLOT': 'lbest'}
TESTNAME='UDP_RR'
#ITERATIONS=3

def real_test_name():
    """retuns the real test name """
    if (USE_TCP) :
        return "tcp_rr"
    else :
        return "udp_rr"


TESTNAME = real_test_name()

RESULT_LOCATION_BASE = '%s_%s' % (RESULT_LOCATION_BASE2, TESTNAME.strip().replace(' ', ''))
# NOTE: The RESULT_LOCATION_BASE  should have absolute path
# NOTE: This location will be created if not present

TOOLS_LOCATION1 = '${HOME}/dragonet/benchmarking/netperf-wrapper/'
TOOLS_LOCATION2 = '${HOME}/git/dragonet/benchmarking/netperf-wrapper/'

include('simple_list_manipulations.py')

server_names=[SERVERS[0] for i in range(0, SERVERS_INSTANCES)]
client_names=expand_client_list(server_names, CLIENTS)
server_if = SERVERS_IF
client_if = CLIENTS_IF
echo_server_name = ECHO_SERVER


psize = PKT_SIZE
server_core_list = gen_core_list(server_names, SERVER_CORES, SERVERS_CORECOUNT, starting_core=SERVER_CORESHIFT)
client_core_list = gen_core_list(client_names, CLIENT_CORES, CLIENTS_CORECOUNT, starting_core=0)



psize = PKT_SIZE
brustsize = BRUST_SIZE
server_onload = SERVER_ONLOAD_CMDLINE
dstat_ignore_initial_x_vals = 4

# FIXME: Change this
custom_header = "pkt=%d, brust=%d srv=%s, onload=%s" % (psize,
            brustsize,
            echo_server_name,
            server_onload,
            )


include('result_parsing_helpers.py')
include('monitors_conf.py') # for tools like dstat, etc

include('echoserver_conf.py')

echo_server_cmds = SRV_CMDS(echo_server_name)

def create_special_client(id):
    client_core_list_SP = client_core_list[id][0:1]
    # FIXME: make sure that id is smaller than client_names
    cl = ('clieSP%d' % (id),
         {
          'deployment_host': client_names[id],
          'result_location': '%s_clieSP%d' % (RESULT_LOCATION_BASE, id),
          'tools_location': TOOLS_LOCATION1,
          'is_server': False,
          'TOOLS': o([
            ( 'netperSP%d' % (id),
            {
                'command': 'taskset -c %s %s %s -P 0 -H %s -t %s -l %d -- -r %d -b %d -k all' % (
                    toCoreList(client_core_list_SP), NETPERF_CMD,  echo_server_cmds['client_extra_opts'],
                    TARGET, TESTNAME, TOTAL_LENGTH,
                    psize, brustsize),
                'runner': 'netperf_sumary',
                'units': 'Gbits/s',
                'wait_for': True,
                'delay': DELAY,
                'is_catastrophic': False,
                'init_cmd': [],
                'out_cmd': [],
                'kill_cmd': ["sudo killall netperf || true"],
            }),

            ('dstat',
            {
                'command': dstatCmd (mname = 'clieSP%d' % (id),
                    cpus=toCoreList(client_core_list_SP), netdev=client_if[client_names[id]]),
                'runner': 'dstat_json',
                'wait_for': True,
                'delay': DELAY,
                'is_catastrophic': True,
                'init_cmd': [],
                'out_cmd': [],
                'kill_cmd': [],
            }),


            ]),
          })
    return cl


def create_client(id):
    # FIXME: make sure that id is smaller than client_names
    cl = ('client%d' % (id),
         {
          'deployment_host': client_names[id],
          'result_location': '%s_client%d' % (RESULT_LOCATION_BASE, id),
          'tools_location': TOOLS_LOCATION1,
          'is_server': False,
          'TOOLS': o([
            ( 'netperf%d' % (id),
            {
                'command': 'taskset -c %s %s %s -P 0 -H %s -t %s -l %d -- -r %d -b %d -P %d,%d -k all' % (
                    toCoreList(client_core_list[id]), NETPERF_CMD,  echo_server_cmds['client_extra_opts'],
                    TARGET, TESTNAME, TOTAL_LENGTH,
                    psize, brustsize,
                    NETPERF_CLIENT_SRC_PORT[id], NETPERF_CLIENT_DST_PORT[id]
                    ),
                'runner': 'netperf_sumary',
                'units': 'Gbits/s',
                'wait_for': True,
                'delay': DELAY,
                'is_catastrophic': False,
                'init_cmd': [],
                'out_cmd': [],
                'kill_cmd': ["sudo killall netperf || true"],
            }),

#            ('dstat',
#            {
#                'command': dstatCmd (mname = 'client%d' % (id),
#                    cpus=toCoreList(client_core_list[id]), netdev=client_if[client_names[id]]),
#                'runner': 'dstat_json',
#                'wait_for': True,
#                'delay': DELAY,
#                'is_catastrophic': True,
#                'init_cmd': [],
#                'out_cmd': [],
#                'kill_cmd': [],
#            }),
#

            ]),
          })
    return cl

def create_client_list(client_names, startid=SPECIAL_CLIENTS_COUNT):
    clist = []
    if startid >= len(client_names):
        return clist
    for i in range(startid, len(client_names)):
       clist.append(create_client(i))
    return clist

def create_special_client_list(client_names, spcount=SPECIAL_CLIENTS_COUNT):
    clist = []
    if spcount > len(client_names):
        spcount = len(client_names)
    for i in range(0, spcount):
       clist.append(create_special_client(i))
    return clist

def create_special_client_attr(id, mname, attr, label, func):
    if label == None or label == "" :
        label = attr
    label = ("SP_%s_%d_%s" % (label, id, mname))
    return result_attr_wrapper(attr, c="netperSP%d" % (id), l=label, func=func)


def create_special_client_attr_list(client_names,  attr, label=None,
                    func=None, spcount=SPECIAL_CLIENTS_COUNT):
    clist = []
    if spcount > len(client_names):
        spcount = len(client_names)
    for i in range(0, spcount):
       clist.append(create_special_client_attr(i, client_names[i], attr, label, func))
    return clist


def create_client_attr(id, mname, attr, label, func):
    if label == None or label == "" :
        label = attr
    label = ("%s_%d_%s" % (label, id, mname))
    return result_attr_wrapper(attr, c="netperf%d" % (id), l=label, func=func)


def create_client_attr_list(client_names,  attr, label=None, func=None,
        startid=SPECIAL_CLIENTS_COUNT):
    clist = []
    if startid >= len(client_names):
        return clist
    for i in range(startid, len(client_names)):
       clist.append(create_client_attr(i, client_names[i], attr, label, func))
    return clist


DATA_SETS = o(
        []
        + create_server_list(server_names)
        + create_special_client_list(client_names)
        + create_client_list(client_names)
        )



def valid_tps(vals) :
    if vals == None or vals == []:
        return 0
    if min(vals) == 0 :
        return 0
    else:
        return sum(vals)

def add_bw(vals) :
    bw = []
    if vals == None or vals == []:
        return 0
    for v in vals:
        if v[-3] == 'M':
            bw.append(float(v[:-3]))
    return sum(bw)

def client_core_list_wrapper():
    if len(client_core_list) > SPECIAL_CLIENTS_COUNT:
        return client_core_list[SPECIAL_CLIENTS_COUNT]
    return []



ATTRIBUTES = o([
    ( 'attrs',
        { 'attrlist' : [
                    meta_attr_wrapper('HWQUEUES'),
                    meta_attr_wrapper('CORES', multiAgg=(lambda x: x['SERVERS_INSTANCES'] * x['SERVER_CORES'])),
                    meta_attr_wrapper('SERVERS_INSTANCES', l="UDP Ports"),
#                    meta_attr_wrapper('SERVERS', agg=len),
                    meta_attr_wrapper('SERVER_CORES', l="Threads/Port"),
                    meta_attr_wrapper('TARGET', agg=(lambda x: target_lookup(x))),

                    meta_attr_wrapper('ECHO_SERVER', l="Server"),
                    meta_attr_wrapper('PKT_SIZE'),
                    meta_attr_wrapper('CLIENTS', agg=(lambda x: len(x) - SPECIAL_CLIENTS_COUNT), type1='invisible'),

                    meta_attr_wrapper('TCONCURRENCY', type1='invisible'),
                    meta_attr_wrapper('CONCURRENCY', type1='invisible'),
#                    result_attr_wrapper("cpu", c="server", l="S CPU", func=get_dstat_attr_cpu, agg=myavg),
                    #result_attr_wrapper("cpu", c="client", l="C CPU", func=get_dstat_attr_cpu, agg=myavg),
                    result_attr_wrapper('TRANSACTION_RATE', c="netperf", l="total TPS", agg=sum),
                    result_attr_wrapper('TRANSACTION_RATE', c="netperf", l="vtotal TPS", agg=valid_tps),
                    #result_attr_wrapper('LOCAL_RECV_THROUGHPUT', c="netperf", l="recv TP", agg=valid_tps),
                    result_attr_wrapper('THROUGHPUT', c="netperf", l="Net_rate", agg=sum),

                    result_attr_wrapper('TRANSACTION_RATE', c="netperf", l="avg TPS", agg=myavg),
                    result_attr_wrapper('TRANSACTION_RATE', c="netperf", l="MIN TPS", agg=min),
                    result_attr_wrapper('MIN_LATENCY', c="netperf", l="get_min", agg=myavg),

                    result_attr_wrapper('MIN_LATENCY', c="netperf", agg=myavg),
                    result_attr_wrapper('RT_LATENCY', c="netperf", agg=myavg),
                    result_attr_wrapper('P50_LATENCY', c="netperf", agg=myavg),
                    result_attr_wrapper('P90_LATENCY', c="netperf", agg=myavg),
                    result_attr_wrapper('P99_LATENCY', c="netperf", agg=myavg),
                    result_attr_wrapper('MAX_LATENCY', c="netperf", agg=myavg),
                    ]
                    + create_special_client_attr_list(client_names, attr= 'RT_LATENCY')
                    + create_special_client_attr_list(client_names, attr= 'TRANSACTION_RATE')

                    + [
                    meta_attr_wrapper('USE_TCP'),
                    #meta_attr_wrapper('SERVER_ONLOAD_CMDLINE', l="Onload"),
                    #result_attr_wrapper('threads count', c="memaslap%d"% (SPECIAL_CLIENTS_COUNT)),
                    #result_attr_wrapper('concurrency', c="memaslap%d" % (SPECIAL_CLIENTS_COUNT)),
                    #result_attr_wrapper('windows size', c="memaslap%d" % (
                    #        SPECIAL_CLIENTS_COUNT), func=get_result_str, agg=find_uniq),

#                   {
#                    'data': get_interrupts,
#                    'args' : {
#                            'mname': 'server-0',
#                            'takeAvg': True},
#                    'label': 'NIC Interrupts'
#                   },

                    meta_attr_wrapper('TITLE', type1='invisible'),
                ]
        }
    )
])



PLOTS = o([
    ('bbox',
     {
      #'description': 'Server: %s, Target: %s, TCP: %s' % (ECHO_SERVER, TARGET, USE_TCP),
      'description': 'TPS, Server: %s, Target: %s %s' % (
            ECHO_SERVER, SERVERS_DRV[SERVERS[0]], TARGET),
      'axis_labels': ["Maximum TPS"],
      'xaxis_label': ["HW queues, Srv Ports, Threads/Port, (simulated clients)"],
      'series': [
                   #meta_attr_wrapper('ECHO_SERVER'),
                   #meta_attr_wrapper('SERVER_ONLOAD_CMDLINE'),
                   #meta_attr_wrapper('TARGET'),
                   #netperf_attr_wrapper ('REQUEST_SIZE'),
                   #netperf_attr_wrapper ('BURST_SIZE'),
                   result_attr_wrapper('TRANSACTION_RATE', l="total TPS"),
                   #result_attr_wrapper('THROUGHPUT', l="Net_rate"),
                   #netperf_attr_wrapper ('MIN_LATENCY'),
                ],
      'type': 'box2',}),

    ('bboxScaleAVG',
     {
      #'description': 'Server: %s, Target: %s, TCP: %s' % (ECHO_SERVER, TARGET, USE_TCP),
      'description': 'TPS, Server: %s, Target: %s %s' % (
            ECHO_SERVER, SERVERS_DRV[SERVERS[0]], TARGET),

      'axis_labels': ["AVG TPS per client"],
      'xaxis_label': ["HW queues, Srv Ports, Threads/Port, (simulated clients)"],
      'groupBy': ['SERVERS_INSTANCES'],
      'series': [
                   result_attr_wrapper('TRANSACTION_RATE', c="netperf", l="avg TPS", agg=myavg, axis=1),
#                   result_attr_wrapper('THROUGHPUT', c="netperf", l="Net_rate", agg=sum, axis=2, color='red'),
                ],
      'type': 'boxscale',}),


    ('bboxScale',
     {
      #'description': 'Server: %s, Target: %s, TCP: %s' % (ECHO_SERVER, TARGET, USE_TCP),
      'description': 'TPS, Server: %s, Target: %s %s' % (
            ECHO_SERVER, SERVERS_DRV[SERVERS[0]], TARGET),

      'dual_axes': True,
      'axis_labels': ["Maximum TPS", 'Bandwidth (Gbps)'],
      'xaxis_label': ["HW queues, Srv Ports, Threads/Port, (simulated clients)"],
      'groupBy': ['SERVERS_INSTANCES'],
      'series': [
                   result_attr_wrapper('TRANSACTION_RATE', c="netperf", l="total TPS", agg=sum, axis=1),
#                   result_attr_wrapper('THROUGHPUT', c="netperf", l="Net_rate", agg=sum, axis=2, color='red'),
                ],
      'type': 'boxscale',}),


    ('bboxNet',
     {
      #'description': 'Server: %s, Target: %s, TCP: %s' % (ECHO_SERVER, TARGET, USE_TCP),
      'description': 'Bandwidth, Server: %s, Target: %s %s' % (
            ECHO_SERVER, SERVERS_DRV[SERVERS[0]], TARGET),
      'axis_labels': ["Bandwidth (Gbps)"],
      'xaxis_label': ["HW queues, Srv Ports, Threads/Port, (simulated clients)"],
      'series': [
                   #meta_attr_wrapper('ECHO_SERVER'),
                   #meta_attr_wrapper('SERVER_ONLOAD_CMDLINE'),
                   meta_attr_wrapper('TARGET'),
                   #netperf_attr_wrapper ('REQUEST_SIZE'),
                   #netperf_attr_wrapper ('BURST_SIZE'),
                   result_attr_wrapper('THROUGHPUT', l="Net_rate"),
                   #netperf_attr_wrapper ('MIN_LATENCY'),
                ],
      'type': 'box2',}),



    ])

#########################################################

